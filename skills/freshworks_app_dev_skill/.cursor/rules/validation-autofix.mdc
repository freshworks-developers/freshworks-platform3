---
name: validation-autofix
description: Pre-finalization validation and autofix for Freshworks Platform 3.0 apps
alwaysApply: true
---

# Validation & Autofix - Pre-Finalization Checklist

**CRITICAL:** After creating ALL app files, you MUST automatically run validation and attempt to fix errors.

## Mandatory Pre-Finalization Process

### Step 1: Automatic Validation After File Creation

**AFTER creating all app files, AUTOMATICALLY run `fdk validate`:**

```bash
cd <app-directory>
fdk validate
```

**This MUST happen automatically - DO NOT ask user to run it manually.**

### Step 2: Automatic Error Fixing (2 Iterations)

**CRITICAL: Only fix FATAL errors - Ignore lint errors and warnings**

**If validation fails, AUTOMATICALLY attempt to fix FATAL errors only:**

**What to FIX (Fatal Errors):**
- ✅ JSON parsing errors (multiple top-level objects, syntax errors)
- ✅ Missing required files (`icon.svg`, `manifest.json`)
- ✅ Manifest structure errors (wrong platform version, invalid module structure)
- ✅ Request template errors (FQDN issues, path issues, invalid schema)
- ✅ Missing declarations in manifest (requests, functions, events)
- ✅ OAuth structure errors (missing `integrations` wrapper)
- ✅ Location placement errors (wrong module)

**What to IGNORE:**
- ❌ Lint errors (async without await, unused parameters, unreachable code)
- ❌ Warnings (non-critical issues)
- ❌ Code style issues
- ❌ Best practice suggestions

1. **First Iteration:**
   - Parse validation output
   - **Filter out lint errors and warnings** - Only process fatal errors
   - Identify fixable fatal issues (JSON structure, syntax errors, missing files, manifest errors)
   - Apply autofixes automatically
   - Re-run `fdk validate`

2. **Second Iteration (if still failing):**
   - Parse remaining fatal errors (ignore lint/warnings)
   - Apply additional fixes for fatal errors only
   - Re-run `fdk validate`

3. **After 2 Iterations:**
   - If fatal errors are resolved → Present app as complete (even if lint warnings remain)
   - If fatal errors persist → Present remaining fatal errors to user with fix directions

**CRITICAL:** You MUST attempt fixes automatically for 2 iterations before asking user for help. **ONLY fix fatal errors - ignore lint and warnings.**

### Step 2: JSON Structure Validation & Autofix

**Common JSON Structure Errors:**

#### Error: "Unexpected token { in JSON" or "Multiple top-level JSON objects"

**Cause:** File contains multiple top-level JSON objects instead of a single object.

**Example of WRONG (requests.json):**
```json
{  "zapierContactSync": {    "schema": {      "method": "POST",
{  "zapierContactSync": {    "schema": {      "method": "POST",      "host": "{{zapier_host}}",      "path": "{{zapier_path}}",      "headers": {        "Content-Type": "application/json"      }    }  }}
```

**Example of WRONG (iparams.json):**
```json
{  "zapier_host": {    "display_name": "Zapier Host",
{  "zapier_host": {    "display_name": "Zapier Host",    "description": "...",    "type": "text",    "required": true,    "default_value": "hooks.zapier.com"  },  "zapier_path": {    "display_name": "Zapier Webhook Path",    "description": "...",    "type": "text",    "required": true  }}
```

**CORRECT Structure (requests.json):**
```json
{
  "freshdeskListContacts": {
    "schema": {
      "method": "GET",
      "host": "<%= iparam.freshdesk_domain %>.freshdesk.com",
      "path": "/api/v2/contacts",
      "headers": {
        "Authorization": "Basic <%= context.auth %>",
        "Content-Type": "application/json"
      },
      "query": {
        "page": "<%= context.page %>"
      }
    }
  },
  "zapierSyncContacts": {
    "schema": {
      "method": "POST",
      "host": "hooks.zapier.com",
      "path": "/<%= iparam.zapier_hook_path %>",
      "headers": {
        "Content-Type": "application/json"
      }
    }
  }
}
```

**CORRECT Structure (iparams.json):**
```json
{
  "freshdesk_domain": {
    "display_name": "Freshdesk Subdomain",
    "description": "Your Freshdesk account subdomain (e.g. \"acme\" if your URL is https://acme.freshdesk.com)",
    "type": "text",
    "required": true
  },
  "freshdesk_api_key": {
    "display_name": "Freshdesk API Key",
    "description": "API key of an account with permission to read contacts",
    "type": "text",
    "required": true,
    "secure": true
  },
  "zapier_hook_path": {
    "display_name": "Zapier Webhook Path",
    "description": "Only the path part of your Zapier hook URL (everything after hooks.zapier.com). Example: hooks/catch/123456/abcdef",
    "type": "text",
    "required": true
  },
  "sync_frequency_minutes": {
    "display_name": "Sync Frequency (minutes)",
    "description": "How often contacts should be synced to Zapier",
    "type": "number",
    "required": true,
    "default_value": 15
  }
}
```

### Autofix Rules for JSON Files

**For config/requests.json:**
1. ✅ MUST be a single top-level JSON object `{ ... }`
2. ✅ All request templates MUST be properties of this object
3. ✅ Use commas to separate multiple request templates
4. ❌ NEVER have multiple `{ ... }` blocks at top level
5. ❌ NEVER have trailing commas after last property

**For config/iparams.json:**
1. ✅ MUST be a single top-level JSON object `{ ... }`
2. ✅ All iparams MUST be properties of this object
3. ✅ Use commas to separate multiple iparams
4. ❌ NEVER have multiple top-level objects
5. ❌ NEVER have trailing commas after last property

**For config/oauth_config.json:**
1. ✅ MUST be a single top-level JSON object `{ "integrations": { ... } }`
2. ✅ All integrations MUST be properties of `integrations` object
3. ❌ NEVER have multiple top-level objects

**For manifest.json:**
1. ✅ MUST be a single top-level JSON object
2. ✅ All modules, engines, etc. MUST be properties of this object
3. ❌ NEVER have multiple top-level objects

### Step 3: Autofix Process

**When you detect JSON structure errors:**

1. **Identify the issue:**
   - Multiple top-level objects
   - Missing commas
   - Trailing commas
   - Invalid JSON syntax

2. **Fix the structure:**
   - Merge multiple objects into single object
   - Ensure proper comma placement
   - Remove trailing commas
   - Validate JSON syntax

3. **Verify the fix:**
   - Run `fdk validate` again
   - Ensure no JSON parse errors
   - Confirm all properties are accessible

### Step 4: Complete Validation Checklist

**Before finalizing, verify:**

- [ ] `fdk validate` passes without errors
- [ ] All JSON files have valid structure (single top-level object)
- [ ] No duplicate properties in JSON files
- [ ] All request templates use correct syntax (`<%= variable %>`)
- [ ] All iparams are properly structured
- [ ] OAuth config (if used) has correct structure
- [ ] Manifest.json is valid Platform 3.0 structure

### Step 5: Finalize Only After Validation Passes

**CRITICAL:** Do NOT present the app as complete until:

1. ✅ `fdk validate` passes
2. ✅ All JSON structure errors are fixed
3. ✅ All lint errors are resolved
4. ✅ All validation errors are addressed

**If validation fails:**
- Fix errors immediately
- Re-run validation
- Only proceed when ALL checks pass

## Common JSON Autofix Patterns

### Pattern 1: Multiple Top-Level Objects

**Error:** `Unexpected token { in JSON`

**Fix:** Merge into single object:
```json
// WRONG
{ "request1": { ... } }
{ "request2": { ... } }

// CORRECT
{
  "request1": { ... },
  "request2": { ... }
}
```

### Pattern 2: Missing Commas

**Error:** `Unexpected token` or `Expected ','`

**Fix:** Add commas between properties:
```json
// WRONG
{
  "param1": { ... }
  "param2": { ... }
}

// CORRECT
{
  "param1": { ... },
  "param2": { ... }
}
```

### Pattern 3: Trailing Commas

**Error:** `Unexpected token }` or parse errors

**Fix:** Remove trailing comma:
```json
// WRONG
{
  "param1": { ... },
  "param2": { ... },
}

// CORRECT
{
  "param1": { ... },
  "param2": { ... }
}
```

### Pattern 4: Invalid Template Syntax

**Error:** FQDN validation errors

**Fix:** Use `<%= variable %>` instead of `{{variable}}`:
```json
// WRONG
"host": "{{subdomain}}.example.com"

// CORRECT
"host": "<%= context.subdomain %>.example.com"
```

## Enforcement Rules

**ALWAYS:**
- ✅ Run `fdk validate` before finalizing
- ✅ Fix JSON structure errors immediately
- ✅ Verify single top-level object in all JSON files
- ✅ Check for proper comma placement
- ✅ Remove trailing commas
- ✅ Use correct template syntax

**NEVER:**
- ❌ Present app without running validation
- ❌ Leave JSON structure errors unfixed
- ❌ Allow multiple top-level JSON objects
- ❌ Skip validation step
- ❌ Finalize with validation errors

**THIS IS MANDATORY - NO EXCEPTIONS**
