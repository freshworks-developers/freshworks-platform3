{
  "description": "Violation test cases - Common mistakes that should be detected and fixed",
  "test_cases": [
    {
      "id": "violation_001",
      "name": "Async function without await",
      "violation": {
        "code": "async function fetchData() {\n  return $request.invokeTemplate('api');\n}",
        "error": "Async function has no 'await' expression"
      },
      "fix": {
        "code": "async function fetchData() {\n  return await $request.invokeTemplate('api');\n}",
        "explanation": "Add 'await' keyword or remove 'async'"
      }
    },
    {
      "id": "violation_002",
      "name": "Unused function parameters",
      "violation": {
        "code": "exports = {\n  handler: function(args) {\n    console.log('Called');\n  }\n}",
        "error": "Parameter 'args' is defined but never used"
      },
      "fix": {
        "code": "exports = {\n  handler: function() {\n    console.log('Called');\n  }\n}",
        "explanation": "Remove unused parameter or prefix with underscore: _args"
      }
    },
    {
      "id": "violation_003",
      "name": "High cyclomatic complexity",
      "violation": {
        "code": "function process(data) {\n  if (a) {\n    if (b) {\n      for (let i = 0; i < items.length; i++) {\n        if (items[i].valid) {\n          // nested logic\n        }\n      }\n    }\n  }\n}",
        "error": "Function complexity exceeds 7"
      },
      "fix": {
        "approach": "Extract helper functions to reduce nesting",
        "example": "function process(data) {\n  const validItems = getValidItems(data);\n  return processItems(validItems);\n}"
      }
    },
    {
      "id": "violation_004",
      "name": "Variable scope with async/await",
      "violation": {
        "code": "let client;\nasync function init() {\n  client = await app.initialized();\n}\ninit();\n// Use client here - race condition!",
        "error": "Race condition - client may not be initialized"
      },
      "fix": {
        "code": "(async function() {\n  const client = await app.initialized();\n  // Use client here safely\n})();",
        "explanation": "Use IIFE pattern to keep client in same scope"
      }
    },
    {
      "id": "violation_005",
      "name": "Missing icon.svg file",
      "violation": {
        "files": [
          "app/index.html",
          "app/scripts/app.js",
          "manifest.json"
        ],
        "error": "FDK validation fails - icon.svg not found"
      },
      "fix": {
        "action": "ALWAYS create app/styles/images/icon.svg",
        "explanation": "Icon file is required for FDK validation"
      }
    },
    {
      "id": "violation_006",
      "name": "Request not declared in manifest",
      "violation": {
        "manifest": {
          "modules": {
            "common": {}
          }
        },
        "code": "$request.invokeTemplate('myApiCall', {})",
        "error": "Request template 'myApiCall' not declared in manifest"
      },
      "fix": {
        "manifest": {
          "modules": {
            "common": {
              "requests": {
                "myApiCall": {}
              }
            }
          }
        },
        "explanation": "All request templates must be declared in manifest.json"
      }
    },
    {
      "id": "violation_007",
      "name": "SMI function not declared in manifest",
      "violation": {
        "manifest": {
          "modules": {
            "common": {}
          }
        },
        "code": "client.request.invoke('myFunction', {})",
        "error": "SMI function 'myFunction' not declared in manifest"
      },
      "fix": {
        "manifest": {
          "modules": {
            "common": {
              "functions": {
                "myFunction": {}
              }
            }
          }
        },
        "explanation": "All SMI functions must be declared in manifest.json"
      }
    },
    {
      "id": "violation_008",
      "name": "OAuth request missing options",
      "violation": {
        "requests_json": {
          "getOAuthData": {
            "schema": {
              "method": "GET",
              "host": "api.github.com",
              "path": "/user"
            }
          }
        },
        "error": "OAuth request missing 'options.oauth' configuration"
      },
      "fix": {
        "requests_json": {
          "getOAuthData": {
            "schema": {
              "method": "GET",
              "host": "api.github.com",
              "path": "/user",
              "headers": {
                "Authorization": "bearer <%= access_token %>"
              }
            },
            "options": {
              "oauth": "github"
            }
          }
        },
        "explanation": "OAuth requests require options.oauth and <%= access_token %> header"
      }
    },
    {
      "id": "violation_009",
      "name": "Missing alwaysApply in .mdc rules",
      "violation": {
        "rule_file": ".cursor/rules/freshworks-platform3.mdc",
        "frontmatter": {
          "alwaysApply": false
        },
        "error": "Rule not activating automatically"
      },
      "fix": {
        "frontmatter": {
          "alwaysApply": true
        },
        "explanation": "Set alwaysApply: true to ensure Platform 3.0 rules are always enforced"
      }
    },
    {
      "id": "violation_010",
      "name": "Missing product module in manifest",
      "violation": {
        "manifest": {
          "platform-version": "3.0",
          "modules": {
            "common": {
              "requests": {}
            }
          }
        },
        "error": "FDK validation fails - at least one product module required"
      },
      "fix": {
        "manifest": {
          "platform-version": "3.0",
          "modules": {
            "common": {
              "requests": {}
            },
            "support_ticket": {}
          }
        },
        "explanation": "Always include at least one product module (even if empty)"
      }
    },
    {
      "id": "violation_011",
      "name": "Helper function before exports block",
      "violation": {
        "code": "function parseUrl(url) {\n  return new URL(url);\n}\n\nexports = {\n  myHandler: function(args) {\n    const parsed = parseUrl(args.url);\n  }\n};",
        "error": "Error while parsing file containing serverless functions. Please use the exports section as recommended in the Serverless Apps section"
      },
      "fix": {
        "approach": "Move helper functions AFTER exports block, or inside exports, or inline",
        "option_1": {
          "code": "exports = {\n  parseUrl: function(url) {\n    return new URL(url);\n  },\n  myHandler: function(args) {\n    const parsed = this.parseUrl(args.url);\n  }\n};",
          "explanation": "Helper function INSIDE exports (use this.helperName)"
        },
        "option_2": {
          "code": "exports = {\n  myHandler: function(args) {\n    const parsed = parseUrl(args.url);\n  }\n};\n\nfunction parseUrl(url) {\n  return new URL(url);\n}",
          "explanation": "Helper function AFTER exports block"
        },
        "option_3": {
          "code": "exports = {\n  myHandler: function(args) {\n    const parseUrl = (url) => new URL(url);\n    const parsed = parseUrl(args.url);\n  }\n};",
          "explanation": "Inline helper function within handler"
        },
        "critical": "FDK's parser fails if functions are defined BEFORE the exports block!"
      }
    },
    {
      "id": "violation_012",
      "name": "Async function without await",
      "violation": {
        "code": "exports = {\n  syncAllContacts: async function(args) {\n    return $request.invokeTemplate('apiCall', {});\n  }\n};",
        "error": "Async method 'syncAllContacts' has no 'await' expression"
      },
      "fix": {
        "option_1": {
          "code": "exports = {\n  syncAllContacts: async function(args) {\n    return await $request.invokeTemplate('apiCall', {});\n  }\n};",
          "explanation": "Add await keyword before async operation"
        },
        "option_2": {
          "code": "exports = {\n  syncAllContacts: function(args) {\n    return $request.invokeTemplate('apiCall', {});\n  }\n};",
          "explanation": "Remove async keyword if no await needed"
        },
        "critical": "If function is marked async, it MUST contain at least one await expression"
      }
    },
    {
      "id": "violation_013",
      "name": "Scheduled event declared in manifest",
      "violation": {
        "manifest": {
          "modules": {
            "common": {
              "events": {
                "onScheduledSync": {
                  "handler": "syncHandler"
                }
              }
            }
          }
        },
        "error": "Invalid event: 'onScheduledSync' for module: common"
      },
      "fix": {
        "manifest": {
          "modules": {
            "common": {
              "events": {}
            }
          }
        },
        "code": "exports = {\n  onAppInstallHandler: async function(args) {\n    await $schedule.create({\n      name: 'dailySync',\n      schedule_at: new Date(Date.now() + 86400000).toISOString(),\n      time_unit: 'days',\n      frequency: 1,\n      data: { syncType: 'full' }\n    });\n  },\n  scheduledSyncHandler: async function(payload) {\n    // Handler called automatically by platform\n    await syncContacts(payload.data);\n  }\n};",
        "explanation": "Scheduled events are created dynamically with $schedule.create(), NOT declared in manifest"
      }
    },
    {
      "id": "violation_014",
      "name": "Unreachable code after return",
      "violation": {
        "code": "exports = {\n  myHandler: function(args) {\n    if (!args.data) {\n      return { error: 'No data' };\n    }\n    const result = processData(args.data);\n    return result;\n  }\n};",
        "error": "Unreachable code"
      },
      "fix": {
        "code": "exports = {\n  myHandler: function(args) {\n    if (!args.data) {\n      return { error: 'No data' };\n    }\n    const result = processData(args.data);\n    return result;\n  }\n};",
        "explanation": "Ensure all code paths are reachable. Remove code after return statements or restructure logic."
      }
    },
    {
      "id": "violation_015",
      "name": "Plain HTML elements instead of Crayons",
      "violation": {
        "html": "<button>Click Me</button>\n<input type=\"text\" />\n<select><option>Item</option></select>\n<textarea></textarea>",
        "error": "Plain HTML form elements not allowed - must use Crayons components"
      },
      "fix": {
        "html": "<fw-button color=\"primary\">Click Me</fw-button>\n<fw-input label=\"Name\" placeholder=\"Enter name\"></fw-input>\n<fw-select label=\"Choose\"><fw-select-option value=\"1\">Item</fw-select-option></fw-select>\n<fw-textarea label=\"Description\"></fw-textarea>",
        "explanation": "ALL form elements MUST use Crayons components (fw-button, fw-input, fw-select, fw-textarea). Plain HTML elements will cause validation failures."
      }
    },
    {
      "id": "violation_016",
      "name": "Missing Crayons CDN in HTML",
      "violation": {
        "html": "<!DOCTYPE html>\n<html>\n<head><title>App</title></head>\n<body><fw-button>Click</fw-button></body>\n</html>",
        "error": "Crayons components used but CDN not included"
      },
      "fix": {
        "html": "<!DOCTYPE html>\n<html>\n<head><title>App</title></head>\n<body><fw-button>Click</fw-button></body>\n<script async type=\"module\" src=\"https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js\"></script>\n<script async nomodule src=\"https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js\"></script>\n</html>",
        "explanation": "ALL HTML files MUST include Crayons CDN (both ESM and nomodule scripts) even if no Crayons components are used yet"
      }
    },
    {
      "id": "violation_017",
      "name": "Client declared in different scopes",
      "violation": {
        "code": "let client;\nasync function init() {\n  client = await app.initialized();\n}\ninit();\n// Use client here - race condition!",
        "error": "'client' declared and assigned in different scopes. Possible asynchronous race condition"
      },
      "fix": {
        "code": "(async function() {\n  const client = await app.initialized();\n  // Use client here safely\n  client.events.on('app.activated', () => {\n    // App logic\n  });\n})();",
        "explanation": "Use IIFE pattern to keep client in same scope. Prevents race conditions."
      }
    }
  ]
}
